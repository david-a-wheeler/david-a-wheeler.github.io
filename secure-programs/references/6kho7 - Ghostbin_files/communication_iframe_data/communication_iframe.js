(function(){"use strict",window.BrowserID=window.BrowserID||{};var a=window.BrowserID,b={KEY_LENGTH:128,PASSWORD_MIN_LENGTH:8,PASSWORD_MAX_LENGTH:80,URL_MAX_LENGTH:2083,PATH_MAX_LENGTH:2048,XHR_DELAY_MS:1e4,MAX_SITE_LOGO_SIZE:131072};for(var c in b)a[c]=b[c]})();var Channel=function(){function e(a){return Array.isArray?Array.isArray(a):a.constructor.toString().indexOf("Array")!=-1}function d(a,c,d){var e=b[c][d];for(var f=0;f<e.length;f++)e[f].win===a&&e.splice(f,1);b[c][d].length===0&&delete b[c][d]}function c(a,c,d,e){function f(b){for(var c=0;c<b.length;c++)if(b[c].win===a)return!0;return!1}var g=!1;if(c==="*")for(var h in b){if(!b.hasOwnProperty(h))continue;if(h==="*")continue;if(typeof b[h][d]=="object"){g=f(b[h][d]);if(g)break}}else b["*"]&&b["*"][d]&&(g=f(b["*"][d])),!g&&b[c]&&b[c][d]&&(g=f(b[c][d]));if(g)throw"A channel is already bound to the same window which overlaps with origin '"+c+"' and has scope '"+d+"'";typeof b[c]!="object"&&(b[c]={}),typeof b[c][d]!="object"&&(b[c][d]=[]),b[c][d].push({win:a,handler:e})}"use strict";var a=Math.floor(Math.random()*1000001),b={},f={},g=function(a){try{var c=JSON.parse(a.data);if(typeof c!="object"||c===null)throw"malformed"}catch(a){return}var d=a.source,e=a.origin,g,h,i;if(typeof c.method=="string"){var j=c.method.split("::");j.length==2?(g=j[0],i=j[1]):i=c.method}typeof c.id!="undefined"&&(h=c.id);if(typeof i=="string"){var k=!1;if(b[e]&&b[e][g])for(var l=0;l<b[e][g].length;l++)if(b[e][g][l].win===d){b[e][g][l].handler(e,i,c),k=!0;break}if(!k&&b["*"]&&b["*"][g])for(var l=0;l<b["*"][g].length;l++)if(b["*"][g][l].win===d){b["*"][g][l].handler(e,i,c);break}}else typeof h!="undefined"&&f[h]&&f[h](e,i,c)};window.addEventListener?window.addEventListener("message",g,!1):window.attachEvent&&window.attachEvent("onmessage",g);return{build:function(b){var g=function(a){if(b.debugOutput&&window.console&&window.console.log){try{typeof a!="string"&&(a=JSON.stringify(a))}catch(c){}console.log("["+j+"] "+a)}};if(!window.postMessage)throw"jschannel cannot run this browser, no postMessage";if(!window.JSON||!window.JSON.stringify||!window.JSON.parse)throw"jschannel cannot run this browser, no JSON parsing/serialization";if(typeof b!="object")throw"Channel build invoked without a proper object argument";if(!b.window||!b.window.postMessage)throw"Channel.build() called without a valid window argument";if(window===b.window)throw"target window is same as present window -- not allowed";var h=!1;if(typeof b.origin=="string"){var i;b.origin==="*"?h=!0:null!==(i=b.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/))&&(b.origin=i[0].toLowerCase(),h=!0)}if(!h)throw"Channel.build() called with an invalid origin";if(typeof b.scope!="undefined"){if(typeof b.scope!="string")throw"scope, when specified, must be a string";if(b.scope.split("::").length>1)throw"scope may not contain double colons: '::'"}var j=function(){var a="",b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(var c=0;c<5;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}(),k={},l={},m={},n=!1,o=[],p=function(a,b,c){var d=!1,e=!1;return{origin:b,invoke:function(b,d){if(!m[a])throw"attempting to invoke a callback of a nonexistent transaction: "+a;var e=!1;for(var f=0;f<c.length;f++)if(b===c[f]){e=!0;break}if(!e)throw"request supports no such callback '"+b+"'";t({id:a,callback:b,params:d})},error:function(b,c){e=!0;if(!m[a])throw"error called for nonexistent message: "+a;delete m[a],t({id:a,error:b,message:c})},complete:function(b){e=!0;if(!m[a])throw"complete called for nonexistent message: "+a;delete m[a],t({id:a,result:b})},delayReturn:function(a){typeof a=="boolean"&&(d=a===!0);return d},completed:function(){return e}}},q=function(a,b,c){return window.setTimeout(function(){if(l[a]){var d="timeout ("+b+"ms) exceeded on method '"+c+"'";(1,l[a].error)("timeout_error",d),delete l[a],delete f[a]}},b)},r=function(a,c,d){if(typeof b.gotMessageObserver=="function")try{b.gotMessageObserver(a,d)}catch(h){g("gotMessageObserver() raised an exception: "+h.toString())}if(d.id&&c){if(k[c]){var i=p(d.id,a,d.callbacks?d.callbacks:[]);m[d.id]={};try{if(d.callbacks&&e(d.callbacks)&&d.callbacks.length>0)for(var j=0;j<d.callbacks.length;j++){var n=d.callbacks[j],o=d.params,q=n.split("/");for(var r=0;r<q.length-1;r++){var s=q[r];typeof o[s]!="object"&&(o[s]={}),o=o[s]}o[q[q.length-1]]=function(){var a=n;return function(b){return i.invoke(a,b)}}()}var t=k[c](i,d.params);!i.delayReturn()&&!i.completed()&&i.complete(t)}catch(h){var u="runtime_error",v=null;typeof h=="string"?v=h:typeof h=="object"&&(h&&e(h)&&h.length==2?(u=h[0],v=h[1]):typeof h.error=="string"&&(u=h.error,h.message?typeof h.message=="string"?v=h.message:h=h.message:v=""));if(v===null)try{v=JSON.stringify(h),typeof v=="undefined"&&(v=h.toString())}catch(w){v=h.toString()}i.error(u,v)}}}else d.id&&d.callback?!l[d.id]||!l[d.id].callbacks||!l[d.id].callbacks[d.callback]?g("ignoring invalid callback, id:"+d.id+" ("+d.callback+")"):l[d.id].callbacks[d.callback](d.params):d.id?l[d.id]?(d.error?(1,l[d.id].error)(d.error,d.message):d.result!==undefined?(1,l[d.id].success)(d.result):(1,l[d.id].success)(),delete l[d.id],delete f[d.id]):g("ignoring invalid response: "+d.id):c&&k[c]&&k[c]({origin:a},d.params)};c(b.window,b.origin,typeof b.scope=="string"?b.scope:"",r);var s=function(a){typeof b.scope=="string"&&b.scope.length&&(a=[b.scope,a].join("::"));return a},t=function(a,c){if(!a)throw"postMessage called with null message";var d=n?"post  ":"queue ";g(d+" message: "+JSON.stringify(a));if(!c&&!n)o.push(a);else{if(typeof b.postMessageObserver=="function")try{b.postMessageObserver(b.origin,a)}catch(e){g("postMessageObserver() raised an exception: "+e.toString())}b.window.postMessage(JSON.stringify(a),b.origin)}},u=function(a,c){g("ready msg received");if(n)throw"received ready message while in ready state.  help!";c==="ping"?j+="-R":j+="-L",v.unbind("__ready"),n=!0,g("ready msg accepted."),c==="ping"&&v.notify({method:"__ready",params:"pong"});while(o.length)t(o.pop());typeof b.onReady=="function"&&b.onReady(v)},v={unbind:function(a){if(k[a]){if(delete k[a])return!0;throw"can't delete method: "+a}return!1},bind:function(a,b){if(!a||typeof a!="string")throw"'method' argument to bind must be string";if(!b||typeof b!="function")throw"callback missing from bind params";if(k[a])throw"method '"+a+"' is already bound!";k[a]=b;return this},call:function(b){if(!b)throw"missing arguments to call function";if(!b.method||typeof b.method!="string")throw"'method' argument to call must be string";if(!b.success||typeof b.success!="function")throw"'success' callback missing from call";var c={},d=[],e=function(a,b){if(typeof b=="object")for(var f in b){if(!b.hasOwnProperty(f))continue;var g=a+(a.length?"/":"")+f;typeof b[f]=="function"?(c[g]=b[f],d.push(g),delete b[f]):typeof b[f]=="object"&&e(g,b[f])}};e("",b.params);var g={id:a,method:s(b.method),params:b.params};d.length&&(g.callbacks=d),b.timeout&&q(a,b.timeout,s(b.method)),l[a]={callbacks:c,error:b.error,success:b.success},f[a]=r,a++,t(g)},notify:function(a){if(!a)throw"missing arguments to notify function";if(!a.method||typeof a.method!="string")throw"'method' argument to notify must be string";t({method:s(a.method),params:a.params})},destroy:function(){d(b.window,b.origin,typeof b.scope=="string"?b.scope:""),window.removeEventListener?window.removeEventListener("message",r,!1):window.detachEvent&&window.detachEvent("onmessage",r),n=!1,k={},m={},l={},b.origin=null,o=[],g("channel destroyed"),j=""}};v.bind("__ready",u),setTimeout(function(){t({method:s("__ready"),params:"ping"},!0)},0);return v}}}();(function(){"use strict",window._={extend:function(a){var b=[].slice.call(arguments,1);_.each(b,function(b){_.each(b,function(b,c){a[c]=b})});return a},each:function(a,b,c){if(_.isArray(a)){var d=a.length;for(var e=0;e<d;++e)b.call(c,a[e],e,a)}else for(var f in a)b.call(c,a[f],f,a)},isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return a===Object(a)},keys:function(a){var b=[];for(var c in a)b.push(c);return b},indexOf:function(a,b){var c=a.length;for(var d=0;d<c;++d)if(a[d]===b)return d;return-1},keyOf:function(a,b){for(var c in a)if(a[c]===b)return c},size:function(a){return _.isArray(a)?a.length:_.keys(a).length},defer:function(a){var b=[].slice.call(arguments,0);b.splice(1,0,0),_.delay.apply(null,b)},delay:function(a,b){var c=[].slice.call(arguments,2);setTimeout(function(){a.apply(null,c)},b)},isEmpty:function(a){if(a===null)return!0;if("length"in a)return a.length===0;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},difference:function(a){var b=[].slice.call(arguments,1),c=[];_.each(a,function(a){var d=!1;_.each(b,function(b){_.indexOf(b,a)!==-1&&(d=!0)}),d||c.push(a)});return c},intersection:function(a){var b=[].slice.call(arguments,1),c=[];_.each(a,function(a){var d=!0;_.each(b,function(b){_.indexOf(b,a)===-1&&(d=!1)}),d&&c.push(a)});return c},escape:function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}}})(),BrowserID.CODE_VERSION="vswLXmy",Hub=function(){function h(){b={},a=[],c=0}function g(c){for(var d in b){var e=b[d];for(var f=0,g;g=e[f];++f)if(g.id===c){e.splice(f,1);break}}for(var h=0,i;i=a[h];++h)if(i.id===c){a.splice(h,1);break}}function f(c){for(var d=0,e;e=a[d];++d)e.callback.apply(null,arguments);var f=b[c];if(f)for(var g=0,h;h=f[g];++g)h.callback.apply(null,arguments)}function e(b,d){a.push({id:c,callback:d?b.bind(d):b});return c++}function d(a,d,e){var f=b[a]=b[a]||[],g=c;f.push({id:c,callback:e?d.bind(e):d}),c++;return g}"use strict";var a=[],b={},c=0;return{all:e,on:d,fire:f,reset:h,off:g}}(),window.Micrajax=function(){function i(c,e,i){var j=b();if(!j)throw"could not get XHR object";j.onreadystatechange=a(d,j,e);var k=(c.type||"GET").toUpperCase(),l=c.contentType||"application/x-www-form-urlencoded",m=g(c.url,k,c.data),i=h(l,k,c.data);j.open(k,m,!0);var n={"Content-type":l};for(var o in c.headers)n[o]=c.headers[o];f(n,j),j.send(i);return j}function h(a,b,c){var d;if(b!=="GET"&&c)switch(a){case"application/json":typeof c=="string"?d=c:d=JSON.stringify(c);break;case"application/x-www-form-urlencoded":d=e(c);break;default:}return d||null}function g(a,b,c){var d=e(c);b==="GET"&&d&&(a+="?"+d);return a}function f(a,b){var c={"X-Requested-With":"XMLHttpRequest",Accept:"application/json;text/plain"};for(var d in a)c[d]=a[d];for(var d in c)b.setRequestHeader(d,c[d])}function e(a){var b=[],c="";for(var d in a)typeof a[d]!="undefined"&&b.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d]));b&&b.length&&(c=b.join("&"));return c}function d(a,b){try{a.readyState===4&&(a.onreadystatechange=c,b&&b(a.responseText,a.status,a.statusText))}catch(d){}}function c(){}function b(){var a;window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));return a}function a(a){var b=[].slice.call(arguments,1),c=function(){return a.apply(null,b.concat([].slice.call(arguments)))};return c}"use strict";var j={ajax:function(a){var b=a.error,c=a.success,d={readyState:0},e=i(a,function(a,e,f){d.status=e,d.responseText=a,d.statusText||(d.statusText=e!==0?f:"error"),d.readyState=4;if(e>=200&&e<300||e===304){var g=a;try{var g=JSON.parse(a)}catch(h){}c&&c(g,a,d)}else b&&b(d,e,a)});d.abort=function(){d.statusText="aborted",e.abort()};return d}};return j}(),function(){"use strict",Function.prototype.bind||(Function.prototype.bind=function(a){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be fBound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a||window,b.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype,e.prototype=new d;return e}),Function.prototype.curry||(Function.prototype.curry=function(){var a=this,b=Array.prototype.slice.call(arguments);return function(){return a.apply(this,b.concat(Array.prototype.slice.call(arguments)))}}),window.console||(window.console={}),window.console.log||(window.console.log=function(){}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")})}(),BrowserID.Mediator=function(){var a=Hub;return{subscribeAll:a.all.bind(a),subscribe:a.on.bind(a),unsubscribe:a.off.bind(a),publish:a.fire.bind(a),reset:a.reset.bind(a)}}(),function(){function n(a,b){a.location=decodeURI(b)}function m(a){return String(a).replace(l,"")}function k(){try{var a="",b=[].slice.call(arguments,0);_.each(b,function(b,c){c>0&&(a+=", ");if(d.isString(b))a+=b;else if(d.isObject(b))try{a+=JSON.stringify(b,null,2)}catch(e){a+="<<object>>"}else d.isFunction(b)?a+="<<function>>":a+=String(b)}),window.console.log(a)}catch(c){}}function j(a){if(a){var b=[].slice.call(arguments,1);a.apply(null,b)}}function i(a){return function(b){b&&b.preventDefault(),a.call(this)}}function h(a,b){var c={};_.each(_.keys(a),function(d){_.indexOf(b,d)!==-1&&(c[d]=a[d])});return c}function g(a,b){var c=a,d=[];for(var e in b)d.push(e+"="+encodeURIComponent(b[e]));d.length&&(c+="?"+d.join("&"));return c}function f(a){var d=b.getInner(a)||"";return c.password(d)?d:null}function e(a){var d=(b.getInner(a)||"").trim();return c.email(d)?d:null}"use strict";var a=BrowserID,b=a.DOM,c=a.Validation,d=a.Helpers=a.Helpers||{},l=/.*@/;_.extend(d,{isObject:function(a){return Object.prototype.toString.apply(a)==="[object Object]"},isString:function(a){return Object.prototype.toString.apply(a)==="[object String]"},isFunction:function(a){return Object.prototype.toString.apply(a)==="[object Function]"},isArray:function(a){return Object.prototype.toString.apply(a)==="[object Array]"},isNull:function(a){return a===null},isUndefined:function(a){return typeof a=="undefined"},getAndValidateEmail:e,getAndValidatePassword:f,toURL:g,whitelistFilter:h,cancelEvent:i,complete:j,log:k,getDomainFromEmail:m,redirect:n})}(),BrowserID.getStorage=function(){var a;try{a=localStorage}catch(b){a={removeItem:function(a){this[a]=null,delete this[a]}}}return a},BrowserID.Storage=function(){function T(){sessionStorage.removeItem("rpRequest")}function S(){if(sessionStorage.rpRequest){var a=JSON.parse(sessionStorage.rpRequest);try{if(!a.origin)throw new Error("rpRequest missing origin");if(!a.params||!a.params.returnTo)throw new Error("rpRequest missing params.returnTo")}catch(b){T();throw b}return a}}function R(a){if(!a.origin)throw new Error("missing origin");if(!a.params||!a.params.returnTo)throw new Error("missing params.returnTo");sessionStorage.rpRequest=JSON.stringify(a)}function Q(){var a=N();if(a){var d="idpVerification"+a;c.removeItem(d)}for(var e=0;e<localStorage.length;++e){var f=localStorage.key(e);if(/^idpVerification/.test(f)){var g;try{g=JSON.parse(c.getItem(f))}catch(h){c.removeItem(f);continue}if(!g||!g.created){c.removeItem(f);continue}var i=(new Date(g.created)).getTime(),j=(new Date).getTime()-b;i<j&&c.removeItem(f)}}}function P(a,b){b||(b=a,a=String(Math.random())),d.name=d.sessionStorage.idpNonce=a,b.created||(b.created=(new Date).toString()),c["idpVerification"+a]=JSON.stringify(b)}function O(a){a=a||N();if(!!a){var b="idpVerification"+a,d=c[b],e;if(d)try{e=JSON.parse(d)}catch(f){c.removeItem(b);throw f}return e}}function N(){var a=sessionStorage.idpNonce||d.name,b;a==="__persona_dialog"&&(a=b);return a}function M(a,b){var d;try{d=JSON.parse(c.emailToUserID);if(typeof d!="object"||d===null)throw new Error("bogus")}catch(e){d={}}_.each(b,function(b){d[b]=a}),c.emailToUserID=JSON.stringify(d)}function L(a){try{var b=JSON.parse(c.usersComputer);if(typeof b!="object")throw new Error("bogus");var d=b[a];d&&(b[a]=null,delete b[a],c.usersComputer=JSON.stringify(b))}catch(e){}}function K(a){try{a=C(a);var b=JSON.parse(c.usersComputer);if(typeof b!="object")throw new Error("bogus");var d=b[a]||{};d.state="ask",c.usersComputer=JSON.stringify(b)}catch(e){}}function J(a){E(a,"denied")}function I(a){E(a,"confirmed")}function H(a){E(a,"seen")}function G(b){if(typeof b!="number")return!1;try{b=C(b);var d=JSON.parse(c.usersComputer),e=d[b];if(e){var f=e.state,g=new Date-Date.parse(e.updated);if(f==="ask")return!0;if(f==="confirmed")return!1;if(f==="denied"&&g>a)return!0;if(f==="seen"&&g>6e4)return!0}}catch(h){return!0}return!1}function F(a){try{a=C(a);var b=JSON.parse(c.usersComputer||"{}");return b[a].state==="confirmed"}catch(d){return!1}}function E(b,d){b=C(b);if(typeof b!="number")throw new Error("bad userid "+b);if(!D(d))throw new Error("invalid state");var e,f,g=0;try{e=JSON.parse(c.usersComputer);if(typeof e!="object")throw new Error("bogus");var h=e[b];if(h){f=h.state,g=Date.parse(h.updated);if(!D(f))throw new Error("corrupt/outdated");if(isNaN(g))throw new Error("corrupt/outdated")}}catch(i){f=undefined,g=0,e={}}f==="denied"&&(new Date).getTime()-g>a&&(f=undefined,g=0);if(d!=="seen"||!f)e[b]={state:d,updated:(new Date).toString()},c.usersComputer=JSON.stringify(e)}function D(a){return a==="seen"||a==="confirmed"||a==="denied"}function C(a){if(typeof a=="number")return a;var b=JSON.parse(c.emailToUserID||"{}");return b[a]}function B(){var a=JSON.parse(c.siteInfo||"{}");for(var b in a)delete a[b].logged_in;c.siteInfo=JSON.stringify(a)}function A(a,b){function d(){var d=t(a,"logged_in");c!==d&&(b(),c=d)}var c=t(a,"logged_in");window.addEventListener?window.addEventListener("storage",d,!1):window.setInterval(d,2e3)}function z(){var a=0,b=JSON.parse(c.siteInfo||"{}");for(var d in b)b[d].logged_in&&a++;return a}function y(a,b){var d=JSON.parse(c[a]||"{}");delete d[b],c[a]=JSON.stringify(d)}function x(a,b){var d=JSON.parse(c[a]||"{}");return d[b]}function w(a,b,d){var e=JSON.parse(c[a]||"{}");e[b]=d,c[a]=JSON.stringify(e)}function v(a){var b=JSON.parse(c.siteInfo||"{}");return _.size(b)}function u(a,b){var d=JSON.parse(c.siteInfo||"{}"),e=d[a];e&&(delete e[b],_.size(e)||delete d[a],c.siteInfo=JSON.stringify(d))}function t(a,b){var d=JSON.parse(c.siteInfo||"{}"),e=d[a];return e&&e[b]}function s(a,b,d){var e=JSON.parse(c.siteInfo||"{}"),f=e[a]=e[a]||{};if(b==="email"&&!k(d))throw new Error("unknown email address");f[b]=d,c.siteInfo=JSON.stringify(e)}function r(){var a;try{var b=JSON.parse(c.returnTo);if(b){if(new Date-new Date(b.at)>72e5)throw new Error("stale");if(typeof b.url!="string")throw new Error("malformed");a=b.url}}catch(d){c.removeItem("returnTo")}return a}function q(a){c.returnTo=JSON.stringify({at:(new Date).toString(),url:a})}function p(){return c.storageCheck}function o(){c.storageCheck="true"}function n(a,b){var c=k(a,b);if(c)delete c.priv,delete c.pub,delete c.cert,l(a,c,b);else throw new Error("unknown email address")}function m(a,b){var d=i(b);if(!d[a])throw new Error("unknown email address");delete d[a],f(d,b);var e=JSON.parse(c.siteInfo||"{}");for(var g in e)e[g].email===a&&delete e[g].email,e[g].logged_in===a&&delete e[g].logged_in;c.siteInfo=JSON.stringify(e)}function l(a,b,c){var d=i(c);b=b||{},d[a]=b,f(d,c)}function k(a,b){var c=i(b);return c&&c[a]}function j(a){return _.size(i(a))}function i(a){try{var b=JSON.parse(c.emails||"{}");if(b)return b[e(a)]||{}}catch(d){}g();return{}}function h(){_.each({emailToUserID:{},emails:{},interaction_data:{},managePage:{},returnTo:null,siteInfo:{},usersComputer:{}},function(a,b){c[b]||(c[b]=JSON.stringify(a))})}function g(){c.removeItem("emails"),c.removeItem("siteInfo"),c.removeItem("managePage"),h()}function f(a,b){var d;try{d=JSON.parse(c.emails||"{}")}catch(f){g(),d={}}d[e(b)]=a,c.emails=JSON.stringify(d)}function e(a){return a||"default"}"use strict";var a=864e5,b=36e5,c=BrowserID.getStorage(),d=window;h();return{addEmail:l,getEmails:i,getEmailCount:j,getEmail:k,removeEmail:m,invalidateEmail:n,storageCheck:{set:o,get:p},site:{set:s,get:t,remove:u,count:v},manage_page:{set:w.curry("managePage"),get:x.curry("managePage"),remove:y.curry("managePage")},usersComputer:{confirmed:F,setConfirmed:I,setDenied:J,shouldAsk:G,setSeen:H,clear:L,forceAsk:K},updateEmailToUserIDMapping:M,loggedInCount:z,watchLoggedIn:A,logoutEverywhere:B,clear:g,setReturnTo:q,getReturnTo:r,setDefaultValues:h,idpVerification:{get:O,set:P,clear:Q,INFO_LIFESPAN_MS:b},rpRequest:{get:S,set:R,clear:T}}}(),BrowserID.Class=function(){function b(c,d){d||(d=c,c=null);var e=d.hasOwnProperty("constructor")?d.constructor:function(){};if(c){var f=function(){};f.prototype=c.prototype,e.prototype=new f,e.sc=c.prototype}else e.prototype={};for(var g in d)e.prototype[g]=d[g];e.prototype.constructor=e,e.extend=b.bind(null,e),e.create=a.bind(null,e);return e}function a(a,b){var c=new a;c.init(b);return c}return b}(),BrowserID.XHRTransport=window.Micrajax,BrowserID.Modules=BrowserID.Modules||{},BrowserID.Modules.Module=function(){"use strict";var a=BrowserID,b=a.Mediator,c=BrowserID.Class({init:function(a){this.subscriptions=[]},checkRequired:function(a){var b=[].slice.call(arguments,1),c;while(c=b.shift())if(!a.hasOwnProperty(c))throw new Error("missing config option: "+c)},importFrom:function(a){var b=[].slice.call(arguments,1),c;while(c=b.shift())a.hasOwnProperty(c)&&(this[c]=a[c])},start:function(a){var b=this;b.options=a||{}},stop:function(){_.each(this.subscriptions,b.unsubscribe),this.subscriptions=[]},destroy:function(){this.stop()},publish:b.publish.bind(b),subscribe:function(a,c,d){var e=b.subscribe(a,c,d||this);this.subscriptions.push(e)},subscribeAll:function(a,c){var d=b.subscribeAll(a,c||this);this.subscriptions.push(d)}});return c}(),BrowserID.Modules.XHR=function(){function v(a){this.outstandingTimers.push(a)}function u(a){var b=this;clearTimeout(a);var c=_.indexOf(b.outstandingTimers,a);c>-1&&b.outstandingTimers.splice(c,1)}function t(a){var b=this.outstandingRequests;b[a.eventTime]=null,delete b[a.eventTime];var c=a.slowRequestTimeout;c&&(u.call(this,c),a.slowRequestTimeout=null),a.duration=(new Date).getTime()-a.eventTime,this.publish("xhr_complete",a)}function s(a){this.publish("xhr_delay",a)}function r(a,b,c,d){var e=this;t.call(e,a);if(!b||b.statusText!=="aborted"){var f=setTimeout(function(){u.call(e,f);var b=o(a,c,d);e.publish("xhr_error",b),p(a.errorHandlers,b)},0);v.call(e,f)}}function q(a,b,c,d){var e=this;t.call(e,a);if(a.defer_success){var f=setTimeout(function(){u.call(e,f),p(a.successHandlers,b,d,c)},0);v.call(e,f)}else p(a.successHandlers,b,d,c)}function p(a,c,d,e){for(var f=0;f<a.length;f++){var g=c;typeof g=="object"&&(g=_.extend({},g)),b(a[f],g,d,e)}}function o(a,b,c){var d=_.extend(a||{}),e=a.xhr||{};d.network=_.extend(d.network||{},{status:e.status,textStatus:b,errorThrown:c,responseText:e.responseText});return d}function n(a){return _.extend({},a,{successHandlers:[a.success],errorHandlers:[a.error],network:{type:a.type.toUpperCase(),url:a.url},eventTime:(new Date).getTime()})}function m(){var a=this,b=a.outstandingRequests;for(var c in b)b[c].xhr.abort(),b[c]=null,delete b[c];var d;while(d=a.outstandingTimers.pop())clearTimeout(d)}function l(a){var b=a.data||{};a=_.extend(a,{type:"POST",data:JSON.stringify(b),contentType:"application/json",processData:!1,defer_success:!0});if(!b.csrf){var c=n(a);return r.call(this,c,null,null,"missing csrf token from POST request")}return this.request(a)}function k(a){a=_.extend(a,{type:"GET",defer_success:!0});return this.request(a)}function j(a){if(a.type==="GET")for(var b in this.outstandingRequests){var c=this.outstandingRequests[b];if(c.type==="GET"&&c.url===a.url)return c}}function i(a){var b=this,c=b.getExistingRequest(a);if(c){c.successHandlers.push(a.success),c.errorHandlers.push(a.error);return c}var e=n(a);b.outstandingRequests[e.eventTime]=e;if(b.time_until_delay){var f=e.slowRequestTimeout=setTimeout(function(){u.call(b,f),s.call(b,e)},b.time_until_delay);v.call(b,f)}b.publish("xhr_start",e);var g=_.extend({},a,{success:q.bind(b,e),error:r.bind(b,e),headers:{"BrowserID-git-sha":d}});e.xhr=b.transport.ajax(g);return e}function h(){var a=this;a.abortAll();var b=a.abortAllListener;window.removeEventListener?window.removeEventListener("beforeunload",b,!1):window.detachEvent&&window.detachEvent("onbeforeunload",b),e.stop.call(this)}function g(a){a=a||{};var b=this;b.outstandingRequests={},b.outstandingTimers=[],b.transport=a.transport||c,b.time_until_delay=a.time_until_delay;var d=b.abortAllListener=m.bind(this);window.addEventListener?window.addEventListener("beforeunload",d,!1):window.attachEvent&&window.attachEvent("onbeforeunload",d),e.init.call(b,a)}"use strict";var a=BrowserID,b=a.Helpers.complete,c=a.XHRTransport,d=BrowserID.CODE_VERSION,e,f=a.Modules.Module.extend({init:g,stop:h,request:i,get:k,post:l,abortAll:m,getExistingRequest:j});e=f.sc;return f}(),BrowserID.Models={},BrowserID.Models.UserContext=function(){"use strict";var a=BrowserID,b,c,d=a.Modules.Module.extend({userid:b,auth_level:b,has_password:b,init:function(a){var b=this;b.setContext(a),c.init.call(b,a)},setContext:function(a){this.importFrom(a,"userid","auth_level","has_password")},getUserId:function(){return this.userid},setUserId:function(a){this.userid=a},setAuthLevel:function(a){this.auth_level=a},getAuthLevel:function(){return this.auth_level||!1},isUserAuthenticated:function(){return!!this.auth_level},hasPassword:function(){return!!this.has_password}});c=d.sc;return d}(),BrowserID.Models.NetworkContext=function(){"use strict";var a=BrowserID,b,c,d=a.Modules.Module.extend({csrf_token:b,local_time:b,domain_key_creation_time:b,code_version:b,cookies:b,random_seed:b,init:function(a){var b=this;b.setContext(a),c.init.call(b,a)},setContext:function(a){this.importFrom(a,"csrf_token","server_time","domain_key_creation_time","code_version","cookies","random_seed"),this.local_time=(new Date).getTime(),a.forceCookiesEnabled&&(this.cookies=a.forceCookiesEnabled)},getCsrfToken:function(){return this.csrf_token},getLocalTime:function(){if(!this.local_time)throw new Error("can't get local time!");return this.local_time},getServerTime:function(){if(!this.server_time)throw new Error("can't get server time!");var a=(new Date).getTime()-this.getLocalTime();return new Date(a+this.server_time)},getDomainKeyCreationTime:function(){if(!this.domain_key_creation_time)throw new Error("can't get domain key creation time!");return new Date(this.domain_key_creation_time)},getCodeVersion:function(){return this.code_version},areCookiesEnabled:function(){return!!this.cookies},getRandomSeed:function(){return this.random_seed}});c=d.sc;return d}(),BrowserID.Models.RpInfo=function(){"use strict";var a=BrowserID,b,c,d=a.Modules.Module.extend({origin:b,backgroundColor:b,siteName:b,siteLogo:b,privacyPolicy:b,termsOfService:b,allowUnverified:!1,returnTo:b,issuer:"default",emailHint:b,userAssertedClaims:b,rpAPI:b,init:function(a){var b=this;b.checkRequired(a,"origin"),b.importFrom(a,"origin","backgroundColor","siteName","siteLogo","privacyPolicy","termsOfService","allowUnverified","returnTo","rpAPI","emailHint","userAssertedClaims"),a.forceIssuer&&(b.issuer=a.forceIssuer),c.init.call(b,a)},getOrigin:function(){return this.origin},getHostname:function(){return this.origin&&this.origin.replace(/^.*:\/\//,"").replace(/:\d*$/,"")},getBackgroundColor:function(){return this.backgroundColor},getSiteName:function(){return this.siteName||this.getHostname()},getSiteLogo:function(){return this.siteLogo},getEmailableSiteLogo:function(){if(/^https:/.test(this.siteLogo))return this.siteLogo},getPrivacyPolicy:function(){return this.privacyPolicy},getTermsOfService:function(){return this.termsOfService},getAllowUnverified:function(){return this.allowUnverified},getReturnTo:function(){return this.returnTo},getIssuer:function(){return this.issuer},isDefaultIssuer:function(){return this.issuer==="default"},getRpAPI:function(){return this.rpAPI},getEmailHint:function(){return this.emailHint},getUserAssertedClaims:function(){return this.userAssertedClaims}});c=d.sc;return d}(),BrowserID.Models.InteractionData=function(){function u(a){var b=s();if(b&&b.length!==0){var f=[];_.each(b,function(a){f.push(e(a,h))}),c.sendInteractionData(f,function(){t(),d(a,f)},function(b){b&&b.network&&b.network.status===413&&t(),d(a,!1)})}else d(a,!1)}function t(){var a=i();delete a.staged,j(a)}function s(){var a=i();return a.staged||[]}function r(a,b){return q(a,b)!==-1}function q(a,b){if(a)for(var c,d=0;c=a[d];++d)if(c[0]===b)return d;return-1}function p(){var a=l();if(!a||!a.orphaned)return!1;var b=a&&a.event_stream,c={"user.user_staged":"user.user_confirmed","user.email_staged":"user.email_confirmed","user.reset_password_staged":"user.reset_password_confirmed","user.reverify_email_staged":"user.reverify_email_confirmed"};for(var d in c){var e=c[d];if(r(b,d)&&!r(b,e))return!0}return!1}function o(a){p()&&localStorage.setItem(f,!0),n(),u(a)}function n(){var a=i();if(a.current){var b=a.staged=a.staged||[];b.unshift(a.current),delete a.current,j(a)}}function m(a){var b=i();b.current=a,j(b)}function l(){var a=i();return a.current}function k(a){n();var b=i();if(localStorage.getItem(f)){localStorage.removeItem(f);var c=a.event_stream||[];r(c,g)||(c.unshift([g,0]),a.event_stream=c)}b.current=a,j(b)}function j(a){try{b.interaction_data=JSON.stringify(a)}catch(c){b.removeItem("interaction_data")}}function i(){var a;try{a=JSON.parse(b.interaction_data)}catch(c){}return a||{}}"use strict";var a=BrowserID,b=a.getStorage(),c=a.Network,d=a.Helpers.complete,e=a.Helpers.whitelistFilter,f="sent_orphan_with_stage",g="staging_continuation",h=["event_stream","lang","screen_size","sample_rate","timestamp","number_emails","number_sites_signed_in","number_sites_remembered","orphaned","new_account","email_type","rp_api"];return{push:k,getCurrent:l,setCurrent:m,stageCurrent:n,publishCurrent:o,getStaged:s,publishStaged:u,clearStaged:t,hasEvent:r}}(),BrowserID.Network=function(){function p(a,b,c,d,e){var f={token:b};c!==null&&(f.pass=c),j({url:a,data:f,success:d,error:e})}function o(a,b,d,e){j({url:b,data:a,success:function(a){a.success?c(d,a):c(d,!1)},error:function(a){a.network.status===429?c(d,!1):c(e,a)}})}function n(){var a;d=a}function m(a){d=g.create(a),e.publish("context_info",a)}function l(a,b){if(d)return c(a,d);try{document.cookie="can_set_cookies=1"}catch(e){}k({url:"/wsapi/session_context",success:function(b){m(b),c(a,d)},error:b})}function k(a){h.get(a)}function j(a){if(!d)return l(j.curry(a),a.error);a.data=a.data||{},a.data.csrf=d.getCsrfToken(),h.post(a)}"use strict";var a=BrowserID,b=a.Helpers,c=b.complete,d,e=a.Mediator,f=a.Modules.XHR,g=a.Models.NetworkContext,h,i=a.Storage,q={init:function(b){b=b||{},b.xhr?h=b.xhr:(h=f.create(),h.init({time_until_delay:a.XHR_DELAY_MS})),this.cookiesEnabledOverride=b&&b.cookiesEnabledOverride,n()},authenticate:function(a,b,c,d,e){j({url:"/wsapi/authenticate_user",data:{email:a,pass:b,ephemeral:!i.usersComputer.confirmed(a),allowUnverified:c},success:d,error:e})},authenticateWithAssertion:function(a,b,c,d){j({url:"/wsapi/auth_with_assertion",data:{assertion:b,ephemeral:!i.usersComputer.confirmed(a)},success:c,error:d})},withContext:l,setContext:function(a,c){if(arguments.length===1){if(!b.isObject(a))throw new Error("invalid context");m(a)}else d&&(d[a]=c)},clearContext:n,logout:function(a,b){j({url:"/wsapi/logout",success:a,error:function(d,e,f){d.network.status===400?c(a):c(b,d)}})},createUser:function(a,b,c,d,e){var f={email:a,pass:b,site:c.getOrigin(),allowUnverified:c.getAllowUnverified(),backgroundColor:c.getBackgroundColor(),siteLogo:c.getEmailableSiteLogo()};o(f,"/wsapi/stage_user",d,e)},emailForVerificationToken:function(a,b,d){k({url:"/wsapi/email_for_token?token="+encodeURIComponent(a),success:function(a){var d=null;a.success!==!1&&(d=_.extend({needs_password:!1},a)),c(b,d)},error:d})},checkUserRegistration:function(a,b,c){k({url:"/wsapi/user_creation_status?email="+encodeURIComponent(a),success:b,error:c})},completeUserRegistration:p.curry("/wsapi/complete_user_creation"),completeEmailRegistration:p.curry("/wsapi/complete_email_confirmation"),requestPasswordReset:function(a,b,c,d){var e={email:a,site:b.getOrigin(),backgroundColor:b.getBackgroundColor(),siteLogo:b.getEmailableSiteLogo()};o(e,"/wsapi/stage_reset",c,d)},completePasswordReset:p.curry("/wsapi/complete_reset"),checkPasswordReset:function(a,b,c){k({url:"/wsapi/password_reset_status?email="+encodeURIComponent(a),success:b,error:c})},requestEmailReverify:function(a,b,c,d){var e={email:a,site:b.getOrigin(),backgroundColor:b.getBackgroundColor(),siteLogo:b.getEmailableSiteLogo()};o(e,"/wsapi/stage_reverify",c,d)},checkEmailReverify:function(a,b,c){k({url:"/wsapi/email_reverify_status?email="+encodeURIComponent(a),success:b,error:c})},sendInteractionData:function(a,b,d){j({url:"/wsapi/interaction_data",data:{data:a},success:function(a){c(b,a.success)},error:d})},changePassword:function(a,b,c,d){j({url:"/wsapi/update_password",data:{oldpass:
a,newpass:b},success:c,error:d})},cancelUser:function(a,b){j({url:"/wsapi/account_cancel",success:a,error:b})},addEmailWithAssertion:function(a,b,d){j({url:"/wsapi/add_email_with_assertion",data:{assertion:a},success:function(a){c(b,a.success)},error:d})},addSecondaryEmail:function(a,b,c,d,e){var f={email:a,pass:b,site:c.getOrigin(),backgroundColor:c.getBackgroundColor(),siteLogo:c.getEmailableSiteLogo()};o(f,"/wsapi/stage_email",d,e)},checkEmailRegistration:function(a,b,c){k({url:"/wsapi/email_addition_status?email="+encodeURIComponent(a),success:b,error:c})},emailRegistered:function(a,b,d){k({url:"/wsapi/have_email?email="+encodeURIComponent(a),success:function(a,d,e){c(b,a.email_known)},error:d})},addressInfo:function(a,b,d,e){b=b||"default",k({url:"/wsapi/address_info?email="+encodeURIComponent(a)+"&issuer="+encodeURIComponent(b),success:function(a,b,e){c(d,a)},error:e})},removeEmail:function(a,b,d){j({url:"/wsapi/remove_email",data:{email:a},success:function(a,d,e){c(b,a.success)},error:d})},certKey:function(a,b,c,d,e,f){var g={email:a,pubkey:b.serialize(),ephemeral:!i.usersComputer.confirmed(a),allowUnverified:d};c!=="default"&&(g.forceIssuer=c),j({url:"/wsapi/cert_key",data:g,success:e,error:f})},listEmails:function(a,b){k({url:"/wsapi/list_emails",success:function(b){c(a,b.emails)},error:b})},cookiesEnabled:function(a,b){l(function(b){var d=b.areCookiesEnabled();typeof q.cookiesEnabledOverride=="boolean"&&(d=q.cookiesEnabledOverride),c(a,d)},b)},prolongSession:function(a,b){j({url:"/wsapi/prolong_session",success:a,error:b})},usedAddressAsPrimary:function(a,b,c){j({url:"/wsapi/used_address_as_primary",data:{email:a},success:b,error:c})},requestTransitionToSecondary:function(a,b,c,d,e){var f={email:a,pass:b,site:c.getOrigin(),backgroundColor:c.getBackgroundColor(),siteLogo:c.getEmailableSiteLogo()};o(f,"/wsapi/stage_transition",d,e)},completeTransitionToSecondary:p.curry("/wsapi/complete_transition"),checkTransitionToSecondary:function(a,b,c){k({url:"/wsapi/transition_status?email="+encodeURIComponent(a),success:b,error:c})}};return q}(),BrowserID.CryptoLoader=function(){function j(a,b){g?b(g):h?i.push(b):(e("https://login.persona.org/v/1fbc72b001/production/bidbundle.js"),i.push(b),h=!0,f("require",window,function(){g=window.require("./lib/jwcrypto"),g.addEntropy(a),h=!1,_.each(i,function(a){a(g)})}))}function f(a,b,c){if(a in b)return c();setTimeout(function(){f(a,b,c)},d)}function e(a){var b=document.createElement("script");b.setAttribute("src",a);var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}"use strict";var a=BrowserID,b=a.Mediator,c=a.Network,d=50,g,h,i=[],k={load:function(a,b){c.withContext(function(b){j(b.getRandomSeed(),a)},b)}};return k}(),BrowserID.Provisioning=function(){"use strict";var a=BrowserID.CryptoLoader,b=2e4,c=function(c,d,e){function l(){f&&clearTimeout(f),f=setTimeout(function(){h("timeoutError","Provisioning timed out.")},b)}function h(a,b){g();return setTimeout(function(){e({code:a,msg:b})},0)}function g(){f&&(f=clearTimeout(f)),m&&m.destroy(),m=undefined,k&&document.body.removeChild(k),k=undefined}var f;if(!e)throw new Error("missing required failure callback");if(!c||!c.email||!c.url||!c.hasOwnProperty("ephemeral"))return h("internal","missing required arguments");var i;try{i=/^(https?:\/\/[^\/]+)\//.exec(c.url)[1]}catch(j){}if(!i)return h("internal","bad provisioning url, can't extract origin");var k=document.createElement("iframe");k.setAttribute("src",c.url),k.style.display="none",k.addEventListener?k.addEventListener("load",l,!1):k.attachEvent&&k.attachEvent("onload",l),document.body.appendChild(k);var m=Channel.build({window:k.contentWindow,origin:i,scope:"vep_prov"}),n;m.bind("beginProvisioning",function(a,b){return{email:c.email,cert_duration_s:c.ephemeral===!1?21600:3600}}),m.bind("genKeyPair",function(b,c){b.delayReturn(!0),a.load(function(a){a.generateKeypair({algorithm:"DS",keysize:BrowserID.KEY_LENGTH},function(a,c){n=c,b.complete(n.publicKey.serialize())})})}),m.bind("raiseProvisioningFailure",function(a,b){g(),h("primaryError",b)}),m.bind("registerCertificate",function(a,b){g(),d(n,b)})};return c}(),BrowserID.User=function(){function M(a,b,d,e,f){var g=f.success;if(!g)return L(m.curry(d,!1),e);var i=f.userid;K(b,i,function(){f.suppress_ask_if_users_computer&&c.usersComputer.setConfirmed(i),h.syncEmails(m.curry(d,g),e)},e)}function L(a,b){H(function(b){c.clear(),b.setAuthLevel(!1),b.setUserId(null),m(a,!0)},b)}function K(a,b,c,d){H(function(d){d.setAuthLevel(a),d.setUserId(b),m(c,!0)},d)}function J(a,b){t=g.create(b);var d=t.getAuthLevel();if(window.$){var e=!d?"removeClass":"addClass";$("body")[e]("authenticated")}t.isUserAuthenticated()?c.usersComputer.setSeen(t.getUserId()):c.clear()}function I(){b.clearContext()}function H(a,c){b.withContext(function(b){a(t,b)},c)}function G(a,c,d,e){var f=h.rpInfo;b.certKey(a,c.publicKey,f.getIssuer(),f.getAllowUnverified(),function(b){E(a,c,b,d,e)},e)}function F(a,b){c.addEmail(a.email,{created:new Date},b)}function E(a,b,d,e,f){var g=h.rpInfo.getIssuer();h.addressInfo(a,function(f){var h=new Date,i=c.getEmail(a,g)||{created:h};_.extend(i,{updated:h,pub:b.publicKey.toSimpleObject(),priv:b.secretKey.toSimpleObject(),cert:d}),f.state==="unverified"?i.unverified=!0:i.unverified&&delete i.unverified,c.addEmail(a,i,g),e&&e(!0)},f)}function D(a){return d.getDomainFromEmail(a.email)}function C(){i&&(clearTimeout(i),i=null)}function B(a,b,d,e){function j(){a(b,function(a){var b=a.status;b==="complete"||b==="mustAuth"?f(a):b==="pending"?i=setTimeout(j,p):m(e,b)},e)}function g(a){c.setReturnTo(""),n=!0,H(function(b){a.status==="complete"&&K("password",a.userid),b.isUserAuthenticated()?h.syncEmails(function(){m(d,a.status)},e):m(d,a.status)},e)}function f(a){q&&r?(h.authenticate(q,r,function(b){H(function(c){a.userid=c.getUserId(),a.status=b?"complete":"mustAuth",g(a)},e)},e),q=r=null):(I(),h.checkAuthentication(function(b){a.status==="complete"&&b!=="password"&&(a.status="mustAuth"),H(function(b){a.userid=b.getUserId(),g(a)},e)},e))}j()}function A(a,b,d,e,f){h.tokenInfo(b,function(g){var h={valid:!1};g?a(b,d,function(a){var b=a.success,d=h;H(function(a){b&&(d=_.extend({valid:b},g),c.setReturnTo(""),a.setAuthLevel("password")),m(e,d)},f)},f):e&&e(h)},f)}function z(a,b,d,e,f){q=a,r=b,d(function(a){a||(a={success:!1});var b=a.success;b||(a.reason="throttle");var d=h.rpInfo.getReturnTo();b&&d&&c.setReturnTo(d),m(e,a)},f)}function y(a,b){H(function(b,d){var e=d.getServerTime(),g=d.getDomainKeyCreationTime();f.load(function(b){var d=h.rpInfo.getIssuer(),f=c.getEmails(d);_.each(f,function(a,f){try{x(b,a,e,g)}catch(h){return c.invalidateEmail(f,d)}}),a()})},b)}function x(a,b,c,d){a.loadPublicKeyFromObject(b.pub);if(!b.cert)throw new Error("missing cert");var e=a.extractComponents(b.cert);if(w(c,d,e))throw new Error("expired cert")}function w(a,b,c){var e=c.payload.exp.valueOf()-a.valueOf();if(e<12e4)return!0;if(!c.payload.iat){d.log("Data Format ERROR: expected cert to have iat property, but found none, marking expired");return!0}if(c.payload.iat<b){d.log("Certificate issued "+c.payload.iat+" is before creation time "+b+", marking expired");return!0}return!1}function v(a){return _.indexOf(u,a)>-1}"use strict";var a=BrowserID,b=a.Network,c=a.Storage,d=a.Helpers,e=a.Mediator,f=a.CryptoLoader,g=a.Models.UserContext,h,i,j=a.Provisioning,k={},l={},m=a.Helpers.complete,n=!1,o=3e3,p=o,q,r,s="https://login.persona.org",t,u=["transition_to_secondary","transition_no_password","transition_to_primary"];h={init:function(a){a=a||{},e.subscribe("context_info",J),a.provisioning&&(j=a.provisioning),a.pollDuration&&(p=a.pollDuration)},reset:function(){j=BrowserID.Provisioning,h.resetCaches(),h.rpInfo=null,n=!1,p=o,q=r=t=null},resetCaches:function(){k={},l={}},setRpInfo:function(a){h.rpInfo=a},setNetwork:function(a){b=a},setOriginEmail:function(a){c.site.set(h.rpInfo.getOrigin(),"email",a)},getOriginEmail:function(){return c.site.get(h.rpInfo.getOrigin(),"email")},userid:function(a,b){if(!a)throw new Error("no longer supports sync get");H(function(b){m(a,b.getUserId())},b)},withContext:H,clearContext:I,createSecondaryUser:function(a,c,d,e){z(a,c,b.createUser.bind(b,a,c,h.rpInfo),function(b){if(b.unverified){var c=k[a];c&&(c.state="unverified")}m(d,b)},e)},createPrimaryUser:function(a,b,c){var d=a.email;h.provisionPrimaryUser(d,a,function(a,e){a==="primary.verified"?h.authenticateWithAssertion(d,e.assertion,function(a){a?b("primary.verified"):b("primary.could_not_add")},c):b(a,e)},c)},provisionPrimaryUser:function(a,b,c,d){h.primaryUserAuthenticationInfo(a,b,function(e){e.authenticated?E(a,e.keypair,e.cert,function(){h.getAssertion(a,s,function(a){a?c("primary.verified",{assertion:a}):c("primary.could_not_add")},d)}):c("primary.verify",b)},d)},primaryUserAuthenticationInfo:function(a,b,d,e){function g(b){l[a]=b,d&&_.defer(function(){d(b)})}var f=c.getEmail(a,h.rpInfo.getIssuer());l=l||{};if(l[a])return g(l[a]);if(f&&f.cert){var i=_.extend({authenticated:!0},f,b);return g(i)}j({email:a,url:b.prov,ephemeral:!c.usersComputer.confirmed(a)},function(a,c){var d=_.extend({keypair:a,cert:c,authenticated:!0},b);g(d)},function(a){if(a.code==="primaryError"){var c=_.extend({authenticated:!1},b);g(c)}else e($.extend(b,{action:{message:a}}))})},waitForUserValidation:B.curry(b.checkUserRegistration),cancelUserValidation:C,tokenInfo:function(a,d,e){b.emailForVerificationToken(a,function(a){a&&(a=_.extend(a,{returnTo:c.getReturnTo()})),m(d,a)},e)},verifyUser:A.curry(b.completeUserRegistration),canSetPassword:function(a,b){H(function(b){m(a,b.hasPassword())},b)},changePassword:function(a,c,d,e){b.changePassword(a,c,function(a){var b=a.success;if(!b)return m(d,b);H(function(a){K("password",a.getUserId(),d,e)},e)},e)},requestPasswordReset:function(a,c,d){var e=h.rpInfo;h.addressInfo(a,function(f){f.state==="unknown"?m(c,{success:!1,reason:"invalid_email"}):f.type==="primary"?m(c,{success:!1,reason:"primary_address"}):z(a,null,b.requestPasswordReset.bind(b,a,e),c,d)},d)},completePasswordReset:A.curry(b.completePasswordReset),waitForPasswordResetComplete:B.curry(b.checkPasswordReset),cancelWaitForPasswordResetComplete:C,requestEmailReverify:function(a,d,e){c.getEmail(a,h.rpInfo.getIssuer())?z(a,null,b.requestEmailReverify.bind(b,a,h.rpInfo),d,e):m(d,{success:!1,reason:"invalid_email"})},waitForEmailReverifyComplete:B.curry(b.checkEmailReverify),cancelWaitForEmailReverifyComplete:C,requestTransitionToSecondary:function(a,c,d,e){var f=h.rpInfo;h.addressInfo(a,function(g){g.state==="unknown"?m(d,{success:!1,reason:"invalid_email"}):g.type==="primary"?m(d,{success:!1,reason:"primary_address"}):z(a,c,b.requestTransitionToSecondary.bind(b,a,c,f),d,e)},e)},completeTransitionToSecondary:A.curry(b.completeTransitionToSecondary),waitForTransitionToSecondaryComplete:B.curry(b.checkTransitionToSecondary),cancelWaitForTransitionToSecondaryComplete:C,cancelUser:function(a,c){b.cancelUser(function(){L(a,c)},c)},logoutUser:function(a,c){h.checkAuthentication(function(d){if(!d)return m(a,d);b.logout(function(){L(a,c)},c)},c)},syncEmails:function(a,d){y(function(){var e=h.getStoredEmailKeypairs();b.listEmails(function(b){H(function(a){var d=a.getUserId();d&&c.updateEmailToUserIDMapping(d,b)});var d=_.keys(e),f=[_.difference(b,d)],g=[_.difference(d,b)],i=[_.intersection(d,b)],j=h.rpInfo.getIssuer();if(!h.rpInfo.isDefaultIssuer()){var k=c.getEmails(j),l=_.keys(k);f.push(_.difference(b,l)),g.push(_.difference(l,b)),i.push(_.intersection(l,b))}_.each(g,function(a,b){_.each(a,function(a){0===b?c.removeEmail(a,"default"):c.removeEmail(a,j)})}),_.each(f,function(a,b){_.each(a,function(a){0===b?F({email:a},"default"):F({email:a},j)})}),m(a)},d)},d)},checkAuthentication:function(a,c){b.cookiesEnabled(function(b){b?H(function(b){m(a,b.getAuthLevel())},c):m(a,b)},c)},checkAuthenticationAndSync:function(a,b){h.checkAuthentication(function(d){d?h.syncEmails(function(){c.getEmailCount()===0?h.logoutUser(function(){m(a,!1)},b):m(a,d)},b):m(a,d)},b)},authenticate:function(a,c,d,e){b.authenticate(a,c,h.rpInfo.getAllowUnverified(),M.curry(a,"password",d,e),e)},authenticateWithAssertion:function(a,c,d,e){b.authenticateWithAssertion(a,c,M.curry(a,"assertion",d,e),e)},isEmailRegistered:function(a,c,d){b.emailRegistered(a,c,d)},addressInfo:function(a,c,d){function e(b){k[a]=b,k[b.email]=b,c&&c(b)}if(k[a])return e(k[a]);b.addressInfo(a,h.rpInfo.getIssuer(),function(b){var c=b.normalizedEmail||a;b.email=c,h.checkForInvalidCerts(c,b,function(a){a.type==="primary"?(a.idpName=_.escape(D(a)),e(a)):e(a)})},d)},checkForInvalidCerts:function(a,b,e){function g(a,b){delete b.priv,delete b.cert,delete l[a],c.addEmail(a,b)}f.load(function(c){var f=h.getStoredEmailKeypair(a);if(!f||!f.cert)return m(e,b);var i;try{i=c.extractComponents(f.cert).payload.iss}catch(j){d.log("Looking for issuer, error parsing cert for"+a+":"+String(j)),g(a,f)}b.issuer!==i?(g(a,f),b.issuerChange=!!i):f.unverified&&"unverified"!==b.state?g(a,f):v(b.state)&&g(a,f),m(e,b)})},addEmail:function(a,c,d,e){z(a,c,b.addSecondaryEmail.bind(b,a,c,h.rpInfo),d,e)},passwordNeededToAddSecondaryEmail:function(a,b){H(function(b){m(a,!b.has_password)},b)},waitForEmailValidation:B.curry(b.checkEmailRegistration),cancelEmailValidation:C,verifyEmail:A.curry(b.completeEmailRegistration),removeEmail:function(a,d,e){var f=h.rpInfo.getIssuer();c.getEmail(a,f)?b.removeEmail(a,function(){c.removeEmail(a,f),m(d)},e):d&&d()},syncEmailKeypair:function(b,c,d){H(function(){f.load(function(e){e.generateKeypair({algorithm:"DS",keysize:a.KEY_LENGTH},function(a,e){G(b,e,c,d)})})})},getAssertion:function(a,b,d,e){function l(h){H(function(e,i){var l=i.getServerTime();f.load(function(e){var f=e.loadSecretKeyFromObject(h.priv),i=l.getTime()+12e4,n=new Date(i);setTimeout(function(){e.assertion.sign(j,{audience:b,expiresAt:n},f,function(f,i){k=e.cert.bundle([h.cert],i),c.site.set(b,"email",a),c.site.set(b,"issuer",g),b!==s&&!c.usersComputer.confirmed(a)&&c.invalidateEmail(a),m(d,k)})},0)})},e)}var g=h.rpInfo.getIssuer(),i=c.getEmail(a,g),j=h.rpInfo.getUserAssertedClaims()||{},k;i?i.priv?setTimeout(function(){l(i)},0):h.addressInfo(a,function(c){c.type==="primary"&&h.rpInfo.isDefaultIssuer()?h.provisionPrimaryUser(a,c,function(c){c==="primary.verified"?h.getAssertion(a,b,d,e):m(d,null)},e):h.syncEmailKeypair(a,function(c){h.getAssertion(a,b,d,e)},e)},e):m(d,null)},getStoredEmailKeypairs:function(){return c.getEmails(h.rpInfo.getIssuer())},getSortedEmailKeypairs:function(){var a=h.getStoredEmailKeypairs(),b=[];for(var c in a)a.hasOwnProperty(c)&&b.push({address:c,info:a[c]});b.sort(function(a,b){var c=a.address>b.address?1:a.address<b.address?-1:0;return c});return b},getStoredEmailKeypair:function(a){return c.getEmail(a,h.rpInfo.getIssuer())},clearStoredEmailKeypairs:function(){c.clear()},getSilentAssertion:function(a,b,d){var e=h.rpInfo;h.checkAuthenticationAndSync(function(f){var g=e.getOrigin(),i=c.site.get(g,"logged_in");i||(i=c.site.get(g,"one_time"));if(!f||!i)return m(b,null,null);h.resetCaches(),h.addressInfo(i,function(e){if(v(e.state))return m(b,null,null);if(!e.issuerChange&&i===a)return m(b,i,null);h.getAssertion(i,g,function(a){a&&c.site.remove(g,"one_time"),m(b,a?i:null,a)},d)})},d)},logout:function(a,b){var d=h.rpInfo;h.checkAuthentication(function(b){b&&c.site.remove(d.getOrigin(),"logged_in"),a&&a(!!b)},b)},setComputerOwnershipStatus:function(a,d,e){H(function(f){f.isUserAuthenticated()?a?(c.usersComputer.setConfirmed(f.getUserId()),b.prolongSession(d,e)):(c.usersComputer.setDenied(f.getUserId()),m(d)):m(e,"user is not authenticated")},e)},isUsersComputer:function(a,b){H(function(d){d.isUserAuthenticated()?m(a,c.usersComputer.confirmed(d.getUserId())):m(b,"user is not authenticated")},b)},shouldAskIfUsersComputer:function(a,b){H(function(d){if(d.isUserAuthenticated()){var e=c.usersComputer.shouldAsk(d.getUserId())&&!n;m(a,e)}else m(b,"user is not authenticated")},b)},usedAddressAsPrimary:function(a,c,d){h.checkAuthentication(function(e){e?b.usedAddressAsPrimary(a,c,d):m(d,"user is not authenticated")},d)}};return h}(),function(){function o(a,b){function k(){e!==null&&(e=null,f.site.remove(c,"logged_in"),a({method:"logout"}))}function j(b){a({method:"login",assertion:b,_internalParams:{silent:!0}})}function i(b){a({method:"ready"})}function h(){d.clearContext(),d.getSilentAssertion(e,function(a,b){a?(b&&j(b),e=a):e!==null&&k(),i()},function(a){g("silent return: err",a),k(),i()},g)}var c=b.origin,e=b.loggedInUser;n(c),h()}function n(a){var c={origin:a},e=f.site.get(a,"issuer");e&&(c.forceIssuer=e);var g=b.Models.RpInfo.create(c);d.setRpInfo(g)}function m(a,b,c){function e(a){a=k(a),c&&c(a||null)}n(a),d.checkAuthenticationAndSync(function(c){c?d.getAssertion(b,a,function(a){e(a||null)},e.curry(null)):e(null)},e.curry(null))}function l(a,b,c){var d=arguments,e;try{e=h.getRunningModule("dialog")}catch(f){return setTimeout(function(){l.apply(null,d)},50)}e.get(a,b,c,c)}function k(a){a!==null&&typeof a=="object"&&a.assertion&&(a=a.assertion);return a}function j(a){if(typeof a=="string")try{a=JSON.parse(a)}catch(b){g("invalid options string: "+a);throw b}return a}"use strict";var a=navigator,b=BrowserID,c=b.internal=b.internal||{},d=b.User,e=b.Network,f=b.Storage,g=b.Helpers.log,h=b.module,i=b.Models.InteractionData;e.init(),e.clearContext(),c.setPersistent=function(a,b){function c(a){b&&b(a)}d.checkAuthentication(function(b){b&&f.site.set(a,"remember",!0),c(!!b||null)},c.curry(null))},c.get=function(a,c,d,e){function n(a){try{i.publishCurrent()}catch(b){}a=k(a),c&&c(a||null)}g=e||b.Helpers.log;try{d=j(d)}catch(h){return}d=_.extend({},d);var o=!!d.silent;if(o){var p=f.site.get(a,"email");p?m(a,p,n):n()}else d.rp_api="internal",l(a,d,n)},c.logout=function(a,b){function c(a){b&&b(a)}n(a),d.logout(b,c.curry(null))},c.logoutEverywhere=function(a){function b(b){a&&a(b)}d.logoutUser(a,b.curry(null))},c.watch=function(a,c,d){g=d||b.Helpers.log;try{c=j(c)}catch(e){return a({error:String(e)})}o(a,c)}}(),function(){function l(){d.watchLoggedIn(g,k)}function k(a){function e(){f.notify({method:"logout"}),i=null,a&&a()}j||b.cookiesEnabled(function(b){if(!b)return a&&a();d.storageCheck.get()?c.getSilentAssertion(i,function(b,c){i===b?f.notify({method:"match"}):b?(c&&f.notify({method:"login",params:c}),i=b):i!==null&&(f.notify({method:"logout"}),i=null),a&&a()},e):c.checkAuthentication(function(b){(i===undefined||i)&&!b?(f.notify({method:"logout"}),i=null):i===null&&!b&&f.notify({method:"match"}),a&&a()})},e)}function h(b){if(!g){g=b;var e={origin:g},f=d.site.get(g,"issuer");f&&(e.issuer=f);var h=a.Models.RpInfo.create(e);c.setRpInfo(h)}}var a=BrowserID,b=a.Network,c=a.User,d=a.Storage,e=a.Models.InteractionData;d.setDefaultValues(),b.init(),c.init();var f=Channel.build({window:window.parent,origin:"*",scope:"mozid_ni"}),g,i,j=!1;f.bind("loggedInUser",function(a,b){i=b}),f.bind("loaded",function(a,b){a.delayReturn(!0),h(a.origin),k(function(){l(),a.complete()})}),f.bind("logout",function(a,b){h(a.origin),i!==null&&(d.site.remove(g,"logged_in"),i=null,f.notify({method:"logout"}))}),f.bind("redirect_flow",function(a,b){h(a.origin),d.rpRequest.set({origin:g,params:JSON.parse(b)});return!0}),f.bind("dialog_running",function(a,b){j=!0}),f.bind("dialog_complete",function(a,b){j=!1;try{var f=e.getCurrent();f&&(_.extend(f,{number_emails:d.getEmailCount()||0,number_sites_signed_in:d.loggedInCount()||0,number_sites_remembered:d.site.count()||0}),e.setCurrent(f),e.publishCurrent())}catch(g){}b&&(c.clearContext(),k())})}()